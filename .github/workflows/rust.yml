name: CI & Release Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  clippy_debug:
    name: Clippy (Debug)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --all-targets -- -D warnings

  clippy_release:
    name: Clippy (Release)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --all-targets --release -- -D warnings

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [clippy_debug, clippy_release]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@nextest
      - uses: Swatinem/rust-cache@v2
      - name: Run unit & integration tests
        run: cargo nextest run --verbose
      - name: Run doctests
        run: cargo test --doc --verbose

  build_release:
    name: Build Release (${{ matrix.suffix }})
    runs-on: ${{ matrix.runner }}
    needs: [test]
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Standard builds ---
          - runner: ubuntu-latest
            os: linux
            arch_variant: standard
            suffix: standard-ubuntu-x64

          - runner: ubuntu-24.04-arm
            os: linux
            arch_variant: standard
            suffix: standard-ubuntu-arm

          - runner: windows-latest
            os: windows
            arch_variant: standard
            suffix: standard-windows-x64

          - runner: windows-11-arm
            os: windows
            arch_variant: standard
            suffix: standard-windows-arm

          - runner: macos-latest
            os: macos
            arch_variant: standard
            suffix: standard-macos-arm

          - runner: macos-15-intel
            os: macos
            arch_variant: x86-64-v3
            suffix: x86-64-v3-macos-x64

          # --- x86-64-v2 builds ---
          - runner: ubuntu-latest
            os: linux
            arch_variant: x86-64-v2
            suffix: x86-64-v2-ubuntu-x64

          - runner: windows-latest
            os: windows
            arch_variant: x86-64-v2
            suffix: x86-64-v2-windows-x64

          # --- x86-64-v3 builds ---
          - runner: ubuntu-latest
            os: linux
            arch_variant: x86-64-v3
            suffix: x86-64-v3-ubuntu-x64

          - runner: windows-latest
            os: windows
            arch_variant: x86-64-v3
            suffix: x86-64-v3-windows-x64

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Set RUSTFLAGS for non-standard CPU variants
        if: matrix.arch_variant != 'standard'
        run: |
          echo "RUSTFLAGS=-C target-cpu=${{ matrix.arch_variant }}" >> "$GITHUB_ENV"
          echo "Using target CPU: ${{ matrix.arch_variant }}"

      - name: Build release binary
        run: cargo build --release --verbose

      - name: Prepare artifact
        shell: bash
        run: |
          mkdir -p dist
          if [ "${{ matrix.os }}" == "windows" ]; then
            cp target/release/pumpkin.exe dist/pumpkin-${{ matrix.suffix }}.exe
          else
            cp target/release/pumpkin dist/pumpkin-${{ matrix.suffix }}
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pumpkin-${{ matrix.suffix }}
          path: dist/
          compression-level: 9

  draft_release:
    name: Create Draft Release
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [build_release]
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Flatten and list artifacts
        run: |
          mkdir -p release
          find artifacts -type f -name "pumpkin-*" -exec cp {} release/ \;
          ls -l release/

      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          prerelease: false
          files: release/pumpkin-*
          tag_name: v$(date +%Y%m%d)-ci
          name: Nightly Build $(date +%Y-%m-%d)
