#!/bin/bash
# .githooks/pre-commit
# Enforces agent write boundaries and session log requirements

set -e

# 1. Determine which agent is committing
AGENT=$(cat .current-agent 2>/dev/null || true)
if [ -z "$AGENT" ]; then
    echo "╔══════════════════════════════════════════════╗"
    echo "║  ERROR: No .current-agent file found.        ║"
    echo "║  Run start-session.sh before committing.     ║"
    echo "╚══════════════════════════════════════════════╝"
    exit 1
fi

# 2. Load contract
CONTRACT="contracts/${AGENT}.toml"
if [ ! -f "$CONTRACT" ]; then
    echo "ERROR: No contract found at '$CONTRACT'"
    exit 1
fi

# 3. Extract write paths from contract
WRITE_PATHS=$(awk '/\[boundaries\]/,/\[/' "$CONTRACT" | grep -oP '"[^"]*/"' | tr -d '"')

# logs/ is always writable for all agents
WRITE_PATHS="$WRITE_PATHS
logs/"

# 4. Check every changed file against write boundaries
CHANGED=$(git diff --cached --name-only)
VIOLATIONS=""

for file in $CHANGED; do
    ALLOWED=false

    # .current-agent is always writable
    if [ "$file" = ".current-agent" ]; then
        ALLOWED=true
    fi

    for wp in $WRITE_PATHS; do
        if echo "$file" | grep -q "^${wp}"; then
            ALLOWED=true
            break
        fi
    done

    if [ "$ALLOWED" = false ]; then
        VIOLATIONS="$VIOLATIONS\n  ✗ $file"
    fi
done

if [ -n "$VIOLATIONS" ]; then
    echo "╔══════════════════════════════════════════════╗"
    echo "║  BOUNDARY VIOLATION — Agent: $AGENT"
    echo "╠══════════════════════════════════════════════╣"
    echo -e "║  Files outside your scope:$VIOLATIONS"
    echo "╠══════════════════════════════════════════════╣"
    echo "║  Your write paths:"
    for wp in $WRITE_PATHS; do
        echo "║    $wp"
    done
    echo "╚══════════════════════════════════════════════╝"
    exit 1
fi

# 5. Verify session log exists for today
TODAY=$(date +%Y-%m-%d)
if ! ls logs/"$TODAY"/*_${AGENT}_* 1>/dev/null 2>&1; then
    echo "╔══════════════════════════════════════════════╗"
    echo "║  ERROR: No session log found for today.      ║"
    echo "║  Agent: $AGENT                               ║"
    echo "║  Expected: logs/$TODAY/XXX_${AGENT}_*.md     ║"
    echo "║                                              ║"
    echo "║  Write your session log before committing.   ║"
    echo "╚══════════════════════════════════════════════╝"
    exit 1
fi

echo "✓ Agent '$AGENT' — boundary check passed"
echo "✓ Session log found"
echo "✓ Commit approved"
